<meta charset="UTF-8"> 
<head>
<style>
	div#view-draft {
		border-width: 5px;
		border-style: solid;
		border-color: pink;
	}

	div.view-round {
		border-width: 5px;
		border-style: solid;
		border-color: orange;
	}
	
	div.view-match {
		display: table-cell;
		
		padding-left: 10px;
		padding-right: 10px;
		
		border-width: 2px;
		border-style: solid;
		border-color: red;
	}
	
	div.view-roundButton {
		display: table-cell;
	}

</style>
</head>
<body>
	
	<div id="header">
		<button type="button" id="btn-newDraft">New Draft</button> 
	</div>
	
	
	<div id="view-draft"></div>
	
	<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
<script>

/*
Database handles data updates
*/
function MatchData(data)
{
	var DELIMITER = ',';
	
	this.indexPlayer1 = -1;
	this.indexPlayer2 = -1;
	this.indexWinner = -1;
	
	this.serialize = function()
	{
		return this.indexPlayer1 + DELIMITER + this.indexPlayer2 + DELIMITER + this.indexWinner;
	}
	
	this.fromSerializedString = function(str)
	{
		var splits = str.split(DELIMITER);
		this.indexPlayer1 = splits[0];
		this.indexPlayer2 = splits[1];
		this.indexWinner = splits[2];
	}
	
	this.print = function()
	{
		console.log(this.serialize());
	}
	
	// constructor
	if (data != undefined)
	{
		this.fromSerializedString(data);
	}
	return this;
}

function RoundData(data)
{
	var DELIMITER = '|';
	
	this.matches = []; // type MatchData
	
	this.serialize = function()
	{
		var str = "";
		this.matches.forEach(function(el){
			str += el.serialize() + DELIMITER;
		});
		return str;
	}
	
	this.fromSerializedString = function(str)
	{
		var splits = str.split(DELIMITER);
		for(var i = 0; i < splits.length; i++)
		{
			this.matches.push(new MatchData(splits[i]));
		}
	}
	
	this.print = function()
	{
		console.log(this.serialize());
	}
	
	// constructor
	if (data != undefined)
	{
		this.fromSerializedString(data);
	}
	return this;
}

function DraftData()
{
	this.players = [];
	this.rounds = []; // RoundData
	
	this.serialize = function()
	{
		var str = '';
		for(var i = 0; i < this.rounds.length; i++)
		{
			str += 'round' + i + '#' + this.rounds[i].serialize();
		}
		return str;
	}
	
	this.fromSerializedString = function(str)
	{
		
	}
 	
	return this;
}

function DB()
{
	var COL_DRAFTS = "drafts";
	var DOC_DRAFT = "1";
	
	// private
	var fb = undefined;
	
	this.createNewUser = function(email, pw)
	{
		console.log("new user: " + email + " - " + pw);
		
		firebase.auth().createUserWithEmailAndPassword(email, pw).catch(function(error) {
			// Handle Errors here.
			var errorCode = error.code;
			var errorMessage = error.message;
			console.log(error);
		});
	}
	
	this.loginAsUser = function(email, pw){
		firebase.auth().signInWithEmailAndPassword(email, pw).then(function(){
			DOC_DRAFT = firebase.auth().currentUser.uid;
			onSignedIn();
		}).catch(function(error) {
			// Handle Errors here.
			var errorCode = error.code;
			var errorMessage = error.message;
			console.log(error);
		});
	}
	
	this.getCurrentUser = function() {
		
	}
	
	this.loadDraftData = function()
	{
		fb.collection(COL_DRAFTS).doc(DOC_DRAFT).get().then(function(doc) {
			if (doc.exists) {
				draft.visualizeDraftData(doc.data());
			} else {
				createNewDraft();
			}
		}).catch(function(error) {
			createNewDraft();
		});
	}
	
	this.newDraft = function(data)
	{
		fb.collection(COL_DRAFTS).doc(DOC_DRAFT).set(data)
		.then(function() {
			console.log("created");
		}).catch(function(error) {
			console.log(error);
		});
		
		draft.visualizeDraftData(data);
	}
	
	this.updateDraft = function(data)
	{
		fb.collection(COL_DRAFTS).doc(DOC_DRAFT).update(data);
	}
	
	this.init = function()
	{
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyBhhBAzfvWRvYUZRg2RuXriQ67SPBkiWOg",
			authDomain: "draftmaster-1c8d9.firebaseapp.com",
			databaseURL: "https://draftmaster-1c8d9.firebaseio.com",
			projectId: "draftmaster-1c8d9",
			storageBucket: "draftmaster-1c8d9.appspot.com",
			messagingSenderId: "138424849758"
		};

		// initialize firestore
		firebase.initializeApp(config);
		fb = firebase.firestore();

		// Disable deprecated features
		fb.settings({
		  timestampsInSnapshots: true
		});
	}
	

	this.init();
	return this;
}

database = DB();
</script>
<script>
function LoginView()
{
	var inputEmail = undefined;
	var inputPassword = undefined;
	
	this.toHtml = function()
	{
		var html = '<div>';
		html += '<input id="input-login-email" type="text" placeholder="email" >';
		html += '<input id="input-login-password" type="password" placeholder="password">';
		html += '<button type="button" id="btn-signIn">Sign In</button>';
		html += '<button type="button" id="btn-signUp">Sign Up</button>';
		return html;
	}
	
	this.onViewAdded = function()
	{
		inputEmail = document.getElementById('input-login-email');
		inputPassword = document.getElementById('input-login-password');
		
		document.getElementById('btn-signIn').onclick = function() { 
			database.loginAsUser(inputEmail.value, inputPassword.value);
		};
		
		document.getElementById('btn-signUp').onclick = function() { 
			database.createNewUser(inputEmail.value, inputPassword.value);
		};
	}
	
	return this;
}


function DraftHeader(_data)
{
	var data = _data;
	
	return this;
}

/* 

		MATCH VIEW

*/

function MatchView(context, _data)
{
	var match = _data;
	var view = undefined;
	var input = undefined;
	
	this.toHtml = function()
	{
		var name1 = match.player1 == -1 ? '?' : context.players[match.player1];
		var name2 = match.player2 == -1 ? '?' : context.players[match.player2];
		
		var html = '<div class="view-match" id="view-match-' + match.id +'">';
		html += '<p>' + name1 + ' vs. ' + name2 + '</p>';
		html += '<input class="input-match-result" type="text" placeholder="Result" value="' + match.result + '">';
		html += '</div>';
		return html;
	}
	
	this.onViewAdded = function()
	{
		view = document.getElementById('view-match-' + match.id);
		input = view.getElementsByClassName('input-match-result')[0];
		input.onchange = this.onInputChange;
	}
	
	this.onInputChange = function()
	{
		match.result = input.value;
		database.updateDraft(context);
	}
	
	return this;
}

/* 

		ROUND VIEW

*/

function RoundView(context, _data)
{
	var round = _data;
	var view = undefined;
	var viewMatches = [];
	
	var onBtnComplete = undefined;
	
	this.setOnBtnComplete = function(callback)
	{
		onBtnComplete = callback;
	};
	
	this.toHtml = function()
	{
		viewMatches = [];
		
		var html = '<div class="view-round" id="view-round-' + round.id +'">';
		for (var i = 0; i < round.matches.length; i++)
		{
			var match = new MatchView(context, round.matches[i]);
			viewMatches.push(match);
			html += match.toHtml();
		}
		
		// attach button onRoundComplete
		if (context.currentRoundId == round.id)
		{
			html += '<div class="view-roundButton"><button type="button" id="btn-roundComplete">Complete</button></div>';
		}
		
		html += '</div>';
		
		return html;
	}
	
	this.onViewAdded = function()
	{
		view = document.getElementById('view-round-' + round.id);
		viewMatches.forEach(function(viewMatch){
			viewMatch.onViewAdded();
		});
		
		// configure button onRoundComplete
		if (context.currentRoundId == round.id) 
		{
			document.getElementById('btn-roundComplete').onclick = function(){
				if (onBtnComplete != undefined)
				{
					onBtnComplete();
				}
			};
		}
	}
	
	
	return this;
}

/*

		DRAFT DATA FUNCTIONS
		
*/

// returns array [numMatchWinsPlayer1, numMatchWinsPlayer2]
function parseMatchResult(matchData)
{
	var split = matchData.result.split(':');
	return [parseInt(split[0]), parseInt(split[1])]
}

// returns array [numRoundWins, numMatchWins, numMatchLosses, [opponentIndices...]]
function getStatsFromPlayerId(data, playerId)
{
	var score = [0, 0, 0, []];
	for(var r = 0; r < data.currentRoundId; r++)
	{
		for(var m = 0; m < data.rounds[r].matches.length; m++)
		{
			var matchData = data.rounds[r].matches[m];
			var result = parseMatchResult(matchData);
			
			var numWins = Math.max((matchData.player1 == playerId ? result[0] : 0), (matchData.player2 == playerId ? result[1] : 0));
			var numLoss = Math.max((matchData.player1 == playerId ? result[1] : 0), (matchData.player2 == playerId ? result[0] : 0));
			
			score[0] += (numWins == 2 ? 1 : 0);
			score[1] += numWins;
			score[2] += numLoss;
			
			if (matchData.player1 == playerId) {
				score[3].push(matchData.player2);
			} else if (matchData.player2 == playerId) {
				score[3].push(matchData.player1);
			}
		}
	}
	
	return score;
}

// returns sorted player list, most wins ASC
function getIntermediateResults(data)
{
	var results = [];
	
	// get results
	for(var p = 0; p < data.players.length; p++)
	{
		results.push({
			playerId: p,
			score: getStatsFromPlayerId(data, p)
		});
	}
	
	// sort results 
	results.sort(function(el1, el2){
		if (el1.score[0] > el2.score[0] || el1.score[1] > el2.score[1] || el1.score[2] < el2.score[2]) {
			return -1;
		} else if(el1.score[0] < el2.score[0] || el1.score[1] < el2.score[1] || el1.score[2] > el2.score[2]) {
			return 1;
		} else {
			return 0;
		}
	});
	
	return results;
}

function chooseNextMatch(results)
{
	// get next player
	var resultp1 = results.shift();
	
	// EQUAL WINS candidates
	var candidates = results.filter(resultC => !resultp1.score[3].includes(resultC.playerId) && resultp1.score[0] == resultC.score[0]);
	// ONE WIN LESS candidates
	if (candidates.length == 0){
		candidates = results.filter(resultC => !resultp1.score[3].includes(resultC.playerId) && resultp1.score[0] == resultC.score[0] + 1);
	}
	
	// choose random enemy from candidates
	var opponent = candidates[0];
	var match = {
		pairing: [resultp1.playerId, opponent.playerId],
		numWins: [resultp1.score[0], opponent.score[0]]
	};
	
	// get index of selected opponent
	var opponentIndex = -1;
	for(var i = 0; i < results.length; i++){
		if (results[i].playerId == opponent.playerId) {
			opponentIndex = i;
			break;
		}
	} 
	
	// remove candidate from players
	results.splice(opponentIndex, 1);
	return match;
}

// 
function nextRound(data)
{	
	data.currentRoundId++;
	var results = getIntermediateResults(data);
	
	if (data.currentRoundId < data.rounds.length) {
		for (var m = 0; m < data.rounds[data.currentRoundId].matches.length; m++)
		{
			var match = chooseNextMatch(results);
			data.rounds[data.currentRoundId].matches[m].player1 = match.pairing[0];
			data.rounds[data.currentRoundId].matches[m].player2 = match.pairing[1];
		}
	}
	
	database.updateDraft(data);
}


/*

		DRAFT VIEW
User Interaction and database visualization

*/

function DraftView(_data)
{
	var draftdata = _data;
	
	var view = undefined; // draft view
	var viewRounds = [];
	
	var onBtnRoundComplete = function()
	{
		nextRound(draftdata);
		_visualizeDraftData(draftdata);
	}
	
	var _visualizeDraftData = function(data)
	{
		draftdata = data;
		this.view = document.getElementById('view-draft');
		this.viewRounds = [];

		var html = "";
		for(var r = 0; r < data.rounds.length; r++)
		{
			var round = new RoundView(data, data.rounds[r]);
			this.viewRounds.push(round);
			html += round.toHtml();
		}
		
		this.view.innerHTML = html;	
		
		// --- send onAddedEvent
		this.viewRounds.forEach(function(viewRound){
			viewRound.onViewAdded();
		});
		
		// --- configure round complete button
		if (draftdata.currentRoundId < draftdata.rounds.length) {
			this.viewRounds[draftdata.currentRoundId].setOnBtnComplete(function(){onBtnRoundComplete();});
		}
	}
	
	this.onClickNewDraft = function()
	{
		database.newDraft(testDraftData());
	}
	
	this.visualizeDraftData = function(data)
	{
		_visualizeDraftData(data);
	}
	
	this.init = function()
	{
		document.getElementById("btn-newDraft").onclick = this.onClickNewDraft;
		
		if (draftdata != undefined)
		{			
			this.visualizeDraftData(draftdata);
		}
	}
	
	this.init();
	return this;
}

var testDraftData = function(){return{
	players: ["P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8"],
	currentRoundId: 0,
	rounds: [
		{
			id: 0,
			matches: [
				{
					id: 0,
					player1: 0,
					player2: 1,
					result: ''
				},
				{
					id: 1,
					player1: 2,
					player2: 3,
					result: ''
				},
				{
					id: 2,
					player1: 4,
					player2: 5,
					result: ''
				},
				{
					id: 3,
					player1: 6,
					player2: 7,
					result: ''
				}
			]
		},
		{
			id: 1,
			matches: [
				{
					id: 4,
					player1: -1,
					player2: -1,
					result: ''
				},
				{
					id: 5,
					player1: -1,
					player2: -1,
					result: ''
				},
				{
					id: 6,
					player1: -1,
					player2: -1,
					result: ''
				},
				{
					id: 7,
					player1: -1,
					player2: -1,
					result: ''
				}
			]
		},
		{
			id: 2,
			matches: [
				{
					id: 8,
					player1: -1,
					player2: -1,
					result: ''
				},
				{
					id: 9,
					player1: -1,
					player2: -1,
					result: ''
				},
				{
					id: 10,
					player1: -1,
					player2: -1,
					result: ''
				},
				{
					id: 11,
					player1: -1,
					player2: -1,
					result: ''
				}
			]
		}
	]
}};

function createNewDraft()
{
	database.newDraft(testDraftData());
}

function onSignedIn()
{
	draft = new DraftView();
	database.loadDraftData();	
}

var login = new LoginView();
document.getElementById('view-draft').innerHTML = login.toHtml();
login.onViewAdded();

</script>
</body>