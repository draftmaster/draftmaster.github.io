<meta charset="UTF-8"> 
<head>
<style>
	div#view-draft {
		border-width: 5px;
		border-style: solid;
		border-color: pink;
	}

	div.view-round {
		border-width: 5px;
		border-style: solid;
		border-color: orange;
	}
	
	div.view-match {
		display: table-cell;
		
		padding-left: 10px;
		padding-right: 10px;
		
		border-width: 2px;
		border-style: solid;
		border-color: red;
	}
	
	div.view-roundButton {
		display: table-cell;
	}

</style>
</head>
<body>
	
	<div id="header">
		<button type="button" id="btn-newDraft">New Draft</button> 
	</div>
	
	
	<div id="view-draft"></div>
	
	<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
<script>
Array.prototype.shuffle = function () {
    var input = this;
 
    for (var i = input.length - 1; i >= 0; i--) {
 
        var randomIndex = Math.floor(Math.random() * (i + 1));
        var itemAtIndex = input[randomIndex];
 
        input[randomIndex] = input[i];
        input[i] = itemAtIndex;
    }
    return input;
}
</script>
<script>
function DB()
{
	/* 
			AUTH
	*/
	
	this.createNewUser = function(email, pw, onSuccess, onError)
	{	
		return firebase.auth().createUserWithEmailAndPassword(email, pw);
	}
	
	this.loginAsUser = function(email, pw){
		return firebase.auth().signInWithEmailAndPassword(email, pw);
	}
	
	this.getCurrentUser = function() {
		return firebase.auth().currentUser;
	}
	
	/* 
			FIRESTORE
	*/
	
	var COL_DRAFTS = "drafts"; // name of active draft collection
	var DOC_DRAFT = undefined;
	
	// firestore 
	var fb = undefined; 
	
	this.newDraft = function(data)
	{
		DOC_DRAFT = firebase.auth().currentUser.uid;
		return fb.collection(COL_DRAFTS).doc(DOC_DRAFT).set(data);
	}
	
	this.loadDraftData = function()
	{
		DOC_DRAFT = firebase.auth().currentUser.uid;
		return fb.collection(COL_DRAFTS).doc(DOC_DRAFT).get();
	}
	
	this.deleteDraft = function()
	{
		DOC_DRAFT = firebase.auth().currentUser.uid;
		return fb.collection(COL_DRAFTS).doc(DOC_DRAFT).delete();
	}
	
	this.updateDraft = function(data)
	{
		DOC_DRAFT = firebase.auth().currentUser.uid;
		return fb.collection(COL_DRAFTS).doc(DOC_DRAFT).update(data);
	}
	
	// Initialize Firebase
	this.init = function()
	{
		var config = {
			apiKey: "AIzaSyBhhBAzfvWRvYUZRg2RuXriQ67SPBkiWOg",
			authDomain: "draftmaster-1c8d9.firebaseapp.com",
			databaseURL: "https://draftmaster-1c8d9.firebaseio.com",
			projectId: "draftmaster-1c8d9",
			storageBucket: "draftmaster-1c8d9.appspot.com",
			messagingSenderId: "138424849758"
		};

		// initialize firestore
		firebase.initializeApp(config);
		fb = firebase.firestore();

		// Disable deprecated features
		fb.settings({
		  timestampsInSnapshots: true
		});
	}
	

	this.init();
	return this;
}

database = DB();
</script>
<script>
function LoginView()
{
	var inputUsername = undefined;
	var inputPassword = undefined;
	var viewStatus = undefined;
	
	var usernameToEmail = '@doesnotexist.com';
	
	var onLogInClick = function()
	{
		viewStatus.innerHTML = 'logging in ...';
		database.loginAsUser(inputUsername.value + usernameToEmail, inputPassword.value)
		.then(onSignedIn)
		.catch(onError);
	}
	
	var onSingUpClick = function()
	{
		viewStatus.innerHTML = 'signing up ...';
		database.createNewUser(inputUsername.value + usernameToEmail, inputPassword.value)
		.then(onSignedIn)
		.catch(onError);
	}
	
	var onError = function(error)
	{
		viewStatus.innerHTML = 'ERROR: ' + error.message;
	}	
	
	this.toHtml = function()
	{
		var html = '<div>';
		html += '<input id="input-login-username" type="text" placeholder="username" >';
		html += '<input id="input-login-password" type="password" placeholder="password">';
		html += '<button type="button" id="btn-logIn">Log In</button>';
		html += '<button type="button" id="btn-signUp">Sign Up</button>';
		html += '<p id="login-status"></p>';
		return html;
	}
	
	this.onViewAdded = function()
	{
		inputUsername = document.getElementById('input-login-username');
		inputPassword = document.getElementById('input-login-password');
		viewStatus = document.getElementById('login-status');
		
		document.getElementById('btn-logIn').onclick = onLogInClick;
		document.getElementById('btn-signUp').onclick = onSingUpClick;
	}
	
	return this;
}
</script>
<script>

</script>
<script>
/*
	
		DRAFT - DATA

*/

function MatchData()
{
	MatchData.matchIdCounter++;
	return {
		id: MatchData.matchIdCounter,
		player1: -1,
		player2: -1,
		result: ''
	}
}
MatchData.matchIdCounter = -1;

function RoundData()
{
	RoundData.roundIdCounter++;
	return {
		id: RoundData.roundIdCounter,
		matches: []
	}
}
RoundData.roundIdCounter = -1;

function DraftData(players)
{
	// shuffle players to have random start pairings
	players.shuffle();
	
	// add wildcard player if uneven amount of players
	if (players.length % 2 == 1)
	{
		players.push(DraftData.PLAYER_WILDCARD);
	}
	
	// init data
	var data = {
		players: players,
		currentRoundId: 0,
		rounds: []
	}
	
	// add empty rounds
	var maxNumRounds = Math.ceil(Math.log2(players.length));
	for(var r = 0; r < maxNumRounds; r++)
	{
		data.rounds.push(new RoundData());
		for(var m = 0; m < players.length / 2; m++)
		{
			data.rounds[r].matches.push(new MatchData());
		}
	}
	
	// decide pairings first round
	for(var p = 0; p < players.length; p+=2)
	{
		data.rounds[0].matches[p/2].player1 = p;
		data.rounds[0].matches[p/2].player2 = p+1;
	}
	
	return data;
}

DraftData.PLAYER_WILDCARD = 'WILDCARD';


/*
	
		DRAFT - VIEWS

*/

function NewDraftView()
{
	var playersContainer = undefined;
	
	var onAddPlayerClick = function()
	{
		// add new player div
		var html = '<div class="view-newPlayer">';
		html += '<input class="input-newPlayerName" type="text" placeholder="Name">';
		html += '<button type="button" class="btn-removeNewPlayer">Remove</button>';
		playersContainer.innerHTML += html + '</div>';
		
		// configure UI
		var newPlayers = playersContainer.getElementsByClassName('view-newPlayer');
		for(var i = 0; i < newPlayers.length; i++)
		{
			newPlayers[i].getElementsByClassName('btn-removeNewPlayer')[0].onclick = function() {
				onRemovePlayerClick(i);
			}
		}
	}
	
	var onRemovePlayerClick = function(index)
	{
		// TODO - passing index not working
	}
	
	var onStartDraftClick = function()
	{
		var newPlayers = Array.from(playersContainer.getElementsByClassName('view-newPlayer'));
		var players = newPlayers.map(el => el.getElementsByClassName('input-newPlayerName')[0].value);	
		var draftdata = new DraftData(players);
		initNewDraft(draftdata);
	}
	
	this.toHtml = function()
	{
		var html = '<div id="view-newDraft">';
		
		html += '</div>';
		
		html += '<div class="footer-newDraft">';
		html += '<button type="button" id="btn-addPlayer">Add Player</button>';
		html += '<button type="button" id="btn-StartDraft">Start Draft</button>';
		html += '</div>';
		
		return html;
	}
	
	this.onViewAdded = function()
	{
		playersContainer = document.getElementById('view-newDraft');
		document.getElementById('btn-addPlayer').onclick = onAddPlayerClick;
		document.getElementById('btn-StartDraft').onclick = onStartDraftClick;
	}
	
	return this;
}

/* 

		MATCH VIEW

*/

function MatchView(context, _data)
{
	var match = _data;
	var view = undefined;
	var input = undefined;
	
	this.toHtml = function()
	{
		var name1 = match.player1 == -1 ? '?' : context.players[match.player1];
		var name2 = match.player2 == -1 ? '?' : context.players[match.player2];
		
		var html = '<div class="view-match" id="view-match-' + match.id +'">';
		html += '<p>' + name1 + ' vs. ' + name2 + '</p>';
		html += '<input class="input-match-result" type="text" placeholder="Result" value="' + match.result + '">';
		html += '</div>';
		return html;
	}
	
	this.onViewAdded = function()
	{
		view = document.getElementById('view-match-' + match.id);
		input = view.getElementsByClassName('input-match-result')[0];
		input.onchange = this.onInputChange;
	}
	
	this.onInputChange = function()
	{
		match.result = input.value;
		database.updateDraft(context);
	}
	
	return this;
}

/* 

		ROUND VIEW

*/

function RoundView(context, _data)
{
	var round = _data;
	var view = undefined;
	var viewMatches = [];
	
	var onBtnComplete = undefined;
	
	this.setOnBtnComplete = function(callback)
	{
		onBtnComplete = callback;
	};
	
	this.toHtml = function()
	{
		viewMatches = [];
		
		var html = '<div class="view-round" id="view-round-' + round.id +'">';
		for (var i = 0; i < round.matches.length; i++)
		{
			var match = new MatchView(context, round.matches[i]);
			viewMatches.push(match);
			html += match.toHtml();
		}
		
		// attach button onRoundComplete
		if (context.currentRoundId == round.id)
		{
			html += '<div class="view-roundButton"><button type="button" id="btn-roundComplete">Complete</button></div>';
		}
		
		html += '</div>';
		
		return html;
	}
	
	this.onViewAdded = function()
	{
		view = document.getElementById('view-round-' + round.id);
		viewMatches.forEach(function(viewMatch){
			viewMatch.onViewAdded();
		});
		
		// configure button onRoundComplete
		if (context.currentRoundId == round.id) 
		{
			document.getElementById('btn-roundComplete').onclick = function(){
				if (onBtnComplete != undefined)
				{
					onBtnComplete();
				}
			};
		}
	}
	
	
	return this;
}

/*

		DRAFT DATA FUNCTIONS
		
*/

// returns array [numMatchWinsPlayer1, numMatchWinsPlayer2]
function parseMatchResult(matchData)
{
	var split = matchData.result.split(':');
	return [parseInt(split[0]), parseInt(split[1])]
}

// returns array [numRoundWins, numMatchWins, numMatchLosses, [opponentIndices...]]
function getStatsFromPlayerId(data, playerId)
{
	var score = [0, 0, 0, []];
	for(var r = 0; r < data.currentRoundId; r++)
	{
		for(var m = 0; m < data.rounds[r].matches.length; m++)
		{
			var matchData = data.rounds[r].matches[m];
			var result = parseMatchResult(matchData);
			
			var numWins = Math.max((matchData.player1 == playerId ? result[0] : 0), (matchData.player2 == playerId ? result[1] : 0));
			var numLoss = Math.max((matchData.player1 == playerId ? result[1] : 0), (matchData.player2 == playerId ? result[0] : 0));
			
			score[0] += (numWins == 2 ? 1 : 0);
			score[1] += numWins;
			score[2] += numLoss;
			
			if (matchData.player1 == playerId) {
				score[3].push(matchData.player2);
			} else if (matchData.player2 == playerId) {
				score[3].push(matchData.player1);
			}
		}
	}
	
	return score;
}

// returns sorted player list, most wins ASC
function getIntermediateResults(data)
{
	var results = [];
	
	// get results
	for(var p = 0; p < data.players.length; p++)
	{
		results.push({
			playerId: p,
			score: getStatsFromPlayerId(data, p)
		});
	}
	
	// sort results 
	results.sort(function(el1, el2){
		if (el1.score[0] > el2.score[0] || el1.score[1] > el2.score[1] || el1.score[2] < el2.score[2]) {
			return -1;
		} else if(el1.score[0] < el2.score[0] || el1.score[1] < el2.score[1] || el1.score[2] > el2.score[2]) {
			return 1;
		} else {
			return 0;
		}
	});
	
	return results;
}

function chooseNextMatch(results)
{
	// get next player
	var resultp1 = results.shift();
	
	// EQUAL WINS candidates
	var candidates = results.filter(resultC => !resultp1.score[3].includes(resultC.playerId) && resultp1.score[0] == resultC.score[0]);
	// ONE WIN LESS candidates
	if (candidates.length == 0){
		candidates = results.filter(resultC => !resultp1.score[3].includes(resultC.playerId) && resultp1.score[0] == resultC.score[0] + 1);
	}
	
	// choose random enemy from candidates
	var opponent = candidates[0];
	var match = {
		pairing: [resultp1.playerId, opponent.playerId],
		numWins: [resultp1.score[0], opponent.score[0]]
	};
	
	// get index of selected opponent
	var opponentIndex = -1;
	for(var i = 0; i < results.length; i++){
		if (results[i].playerId == opponent.playerId) {
			opponentIndex = i;
			break;
		}
	} 
	
	// remove candidate from players
	results.splice(opponentIndex, 1);
	return match;
}

// 
function nextRound(data)
{	
	data.currentRoundId++;
	var results = getIntermediateResults(data);
	
	if (data.currentRoundId < data.rounds.length) {
		for (var m = 0; m < data.rounds[data.currentRoundId].matches.length; m++)
		{
			var match = chooseNextMatch(results);
			data.rounds[data.currentRoundId].matches[m].player1 = match.pairing[0];
			data.rounds[data.currentRoundId].matches[m].player2 = match.pairing[1];
		}
	}
	
	database.updateDraft(data);
}


/*

		DRAFT VIEW
User Interaction and database visualization

*/

function DraftView(_data)
{
	var draftdata = _data;
	
	var view = undefined; // draft view
	var viewRounds = [];
	
	var onBtnRoundComplete = function()
	{
		nextRound(draftdata);
		_visualizeDraftData(draftdata);
	}
	
	var _visualizeDraftData = function(data)
	{
		draftdata = data;
		this.view = document.getElementById('view-draft');
		this.viewRounds = [];

		var html = "";
		for(var r = 0; r < data.rounds.length; r++)
		{
			var round = new RoundView(data, data.rounds[r]);
			this.viewRounds.push(round);
			html += round.toHtml();
		}
		
		this.view.innerHTML = html;	
		
		// --- send onAddedEvent
		this.viewRounds.forEach(function(viewRound){
			viewRound.onViewAdded();
		});
		
		// --- configure round complete button
		if (draftdata.currentRoundId < draftdata.rounds.length) {
			this.viewRounds[draftdata.currentRoundId].setOnBtnComplete(function(){onBtnRoundComplete();});
		}
	}
	
	this.onClickNewDraft = function()
	{
		database.deleteDraft().then(function(){
			loadDraftOrCreateNew();
		});
	}
	
	this.visualizeDraftData = function(data)
	{
		_visualizeDraftData(data);
	}
	
	this.init = function()
	{
		document.getElementById("btn-newDraft").onclick = this.onClickNewDraft;
		
		if (draftdata != undefined)
		{			
			this.visualizeDraftData(draftdata);
		}
	}
	
	this.init();
	return this;
}
</script>
<script>

function showLoginView()
{
	var login = new LoginView();
	document.getElementById('view-draft').innerHTML = login.toHtml();
	login.onViewAdded();		
}

function showNewDraftView()
{
	var newDraftView = new NewDraftView();
	document.getElementById('view-draft').innerHTML = newDraftView.toHtml();
	newDraftView.onViewAdded();
}

function onInitialised()
{
	var user = database.getCurrentUser();
	if (user == undefined) {	
		showLoginView();
	} else {
		onSignedIn();
	}
}

function onSignedIn()
{
	loadDraftOrCreateNew();
}

function loadDraftOrCreateNew()
{
	draft = new DraftView();
	
	database.loadDraftData().then(function(doc) {
		if (doc.exists) {
			draft.visualizeDraftData(doc.data());
		} else {
			showNewDraftView();
		}
	}).catch(function(error) {
		showNewDraftView();
	});
}

function initNewDraft(newDraftData)
{
	database.newDraft(newDraftData)
	.then(function() {
		draft.visualizeDraftData(newDraftData);	
	}).catch(function(error) {
		console.log(error);
	});
}

setTimeout(onInitialised, 1000);
</script>
</body>